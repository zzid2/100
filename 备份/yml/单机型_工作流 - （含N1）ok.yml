#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#
#-----------------------------------------------------------------------------------------------------------------
# #è¿è¡Œé¢„è®¡æ—¶é—´é¢„è§ˆ#
# Set up job_å¼€å§‹è¿è¡Œ                                          5ç§’
# Checkout_å‡†å¤‡ç¯å¢ƒ                                            2ç§’
# å‡†å¤‡ç¼–è¯‘_å¾®ä¿¡é€šçŸ¥                                            2ç§’
# Initialization environment_åˆå§‹åŒ–ç¯å¢ƒ                        5åˆ†30ç§’
# Clone source code_ä¸‹è½½æºç                                    12ç§’
# Load custom feeds_åŠ è½½DIY_1è„šæœ¬                              3ç§’
# Update feeds & Install feeds_æ›´æ–°æº&å®‰è£…æº                   1åˆ†é’Ÿ
# Load custom configuration_åŠ è½½DIY_1è„šæœ¬                      1ç§’
# SSH connection to Actions_SSHé“¾æ¥                            0ç§’
# Download package_ä¸‹è½½DLåº“                                    7åˆ†é’Ÿ
# Compile the firmware_å¼€å§‹ç¼–è¯‘å›ºä»¶                            2å°æ—¶10åˆ†é’Ÿ
# Check space usage_æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ                           0ç§’
# Upload bin directory_ä¸Šä¼ binç›®å½•                             0ç§’
# Organize files_æ•´ç†æ–‡ä»¶                                      0ç§’
# Upload firmware directory_ä¸Šè½½å›ºä»¶ç›®å½•                       12ç§’
# Upload firmware to cowtransfer_å°†å›ºä»¶ä¸Šè½½åˆ°cowtransfer
# Upload firmware to WeTransfer_å°†å›ºä»¶ä¸Šè½½åˆ°WeTransfer         10ç§’
# Generate release tag_ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
# Upload firmware to release_ä¸Šè½½å›ºä»¶ä»¥å‘å¸ƒ
# Delete workflow runs_åˆ é™¤å·¥ä½œæµè¿è¡Œ                           2ç§’
# Remove old Releases_åˆ é™¤æ—§ç‰ˆæœ¬
# é¢„è®¡2ä¸ªåŠå°æ—¶ç»“æŸ

#-----------------------------------------------------------------------------------------------------------------

#â†â†‘â†’â†“â†–â†™â†—â†˜â†•ç®­å¤´ç¬¦å·

#-----------------------------------------------------------------------------------------------------------------
# #1.å¯åŠ¨å·¥ä½œæµ
name: ç¼–è¯‘OpenWRTå›ºä»¶ #ğŸ‘ˆå·¥ä½œæµåç§°
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:


#-----------------------------------------------------------------------------------------------------------------
# #2.æ·»åŠ å·¥ä½œæµé€‰é¡¹
      ssh:
        description: 'SSHè¿œç¨‹'
        required: false
        default: 'true-false' # true=å¼€å¯ false=å…³é—­
      wxtz:
        description: 'å¾®ä¿¡é€šçŸ¥'
        required: false
        default: 'wxtz'  # wxtz=å¼€å¯ false=å…³é—­
      release:
        description: 'å‘å¸ƒå›ºä»¶'
        required: false
        default: 'release'


#-----------------------------------------------------------------------------------------------------------------
# #3.å®šæ—¶è§¦å‘ç¼–è¯‘ & ç‚¹â˜†Starè§¦å‘ç¼–è¯‘
#å®šæ—¶è§¦å‘å¼€å§‹ç¼–è¯‘(æŠŠä¸‹é¢ä¸¤ä¸ª#å»æ‰å¼€å¯,æ—¶é—´è®¾ç½®è¯·çœ‹å®šæ—¶ç¼–è¯‘è¯´æ˜)
#  schedule:
#    - cron: 0 23 * * *

#ç‚¹â˜†Starè§¦å‘å¼€å§‹ç¼–è¯‘
#  watch:
#    types: started


#-----------------------------------------------------------------------------------------------------------------
# #4.ç¼–è¯‘å‰é…ç½®å„é¡¹å¼€å…³
env:
  FIRMWARE_NAME: OpenWRT_xN1                                      #å¾®ä¿¡æ¨é€æ—¶ å›ºä»¶åç§°ï¼ˆä¸èƒ½æœ‰ä¸­æ–‡ï¼‰
  GITHUB_RELEASE: https://github.com/zuoweiid/N1/releases         #GitHubå‘å¸ƒåœ°å€ï¼Œä¿®æ”¹æˆè‡ªå·±çš„
  REPO_URL: https://github.com/coolsnowwolf/lede                  #OpenWRTæºç åœ°å€
  REPO_BRANCH: master             #â†æºç åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default  #è‡ªå®šä¹‰feedsæ–‡ä»¶
  CONFIG_FILE: .config            #è‡ªå®šä¹‰configé…ç½®       å¤šæœºå‹é…ç½®æ–‡ä»¶å¦‚ï¼š(config/N1.config)
  DIY_P1_SH: diy-part1.sh         #è‡ªå®šä¹‰è„šæœ¬             å¤šæœºå‹è„šæœ¬æ–‡ä»¶å¦‚ï¼š(scripts/diy-part1.sh)
  DIY_P2_SH: diy-part2.sh         #è‡ªå®šä¹‰è„šæœ¬             å¤šæœºå‹è„šæœ¬æ–‡ä»¶å¦‚ï¼š(scripts/diy-part2.sh)
#  ORGANIZE_FIRMWARE: false              #æ•´ç†å›ºä»¶æ¸…é™¤packages
  UPLOAD_CONFIG: true            #â†ä¸Šä¼ configé…ç½®æ–‡ä»¶
  UPLOAD_FIRMWARE: true          #â†ä¸Šä¼ å›ºä»¶åˆ°gitthubç©ºé—´ï¼ˆé»˜è®¤å¿…é€‰trueï¼‰
  UPLOAD_BIN_DIR: true           #â†ä¸Šä¼ binæ–‡ä»¶å¤¹åˆ°_githubç©ºé—´ï¼ˆå›ºä»¶+ipkï¼‰
  UPLOAD_RELEASE: true           #â†å‘å¸ƒå›ºä»¶åˆ°_/releasesä¸»é¡µ
  UPLOAD_COWTRANSFER: true        #â†ä¸Šä¼ åˆ°_å¥¶ç‰›å¿«ä¼ 
  UPLOAD_WETRANSFER: true         #â†ä¸Šä¼ åˆ°_WeTransfer
  EXTRACT_LINKS: true            #æå–å¥¶ç‰›å¿«ä¼ å’ŒWeTransferé“¾æ¥
  TZ: Asia/Shanghai               #â†æ—¶åŒºè®¾ç½®

  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}  # GitHubä»¤ç‰Œ
  SCKEY: ${{ secrets.SCKEY }}            # SCKEYå¯†é’¥

#-----------------------------------------------------------------------------------------------------------------
# #5.å¯åŠ¨è„šæœ¬ç¼–è¯‘ & ç¼–è¯‘ç¯å¢ƒç³»ç»Ÿ
jobs:
  build:
    runs-on: ubuntu-18.04   #â†ç¼–è¯‘ç³»ç»Ÿç‰ˆæœ¬
    steps:
    - name: å‡†å¤‡ç¯å¢ƒ #Checkout
      uses: actions/checkout@main

#-----------------------------------------------------------------------------------------------------------------
# #settings.iniè„šæœ¬è®¾ç½®
#REPO_URL="https://github.com/project-openwrt/openwrt"     #ç¼–è¯‘å›ºä»¶æºç é“¾æ¥ï¼ˆè¯·å‹¿ä¿®æ”¹ï¼‰
#REPO_BRANCH="openwrt-18.06"         #æºç é“¾æ¥çš„åˆ†æ”¯ï¼ˆè¯·å‹¿ä¿®æ”¹ï¼‰
#CONFIG_FILE=".config"               #é…ç½®æ–‡ä»¶ï¼ˆå¯SSHè¿œç¨‹å®šåˆ¶å›ºä»¶æ’ä»¶ï¼Œä¹Ÿå¯åœ¨æœ¬åœ°æå–é…ç½®ç²˜è´´åˆ°æ­¤æ–‡ä»¶ï¼‰
#WXFB_MESSAGE="project_x86_64"       #å¾®ä¿¡é€šçŸ¥è·Ÿå‘å¸ƒè¦ç”¨åˆ°çš„åå­—,æ¯”å¦‚é€šçŸ¥ä½ XXå¼€å§‹ç¼–è¯‘,å‘å¸ƒçš„æ—¶å€™æ˜¾ç¤ºXXå›ºä»¶
#DIY_P1_SH="diy-1.sh"                #è‡ªå®šä¹‰æ–‡ä»¶1
#DIY_P2_SH="diy-2.sh"                #è‡ªå®šä¹‰æ–‡ä»¶2
#SSH_ACTIONS="false"                 #SSHè¿œç¨‹é…ç½®å›ºä»¶ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#UPLOAD_BIN_DIR="false"              #ä¸Šä¼ ã€binæ–‡ä»¶å¤¹ã€‘åˆ°githubç©ºé—´ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#UPLOAD_CONFIG="true"                #ä¸Šä¼ ã€.configã€‘é…ç½®æ–‡ä»¶åˆ°githubç©ºé—´ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#UPLOAD_FIRMWARE="true"              #ä¸Šä¼ å›ºä»¶åˆ°githubç©ºé—´ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#UPLOAD_COWTRANSFER="false"          #ä¸Šä¼ å›ºä»¶åˆ°åˆ°ã€å¥¶ç‰›å¿«ä¼ ã€‘å’Œã€WETRANSFERã€‘ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#UPLOAD_RELEASE="false"              #å‘å¸ƒå›ºä»¶ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰
#SERVERCHAN_SCKEY="false"            #å¾®ä¿¡é€šçŸ¥ï¼ˆtrue=å¼€å¯ï¼‰ï¼ˆfalse=å…³é—­ï¼‰


#-----------------------------------------------------------------------------------------------------------------
# #6.æ·»åŠ å¾®ä¿¡é€šçŸ¥
    - name: å‡†å¤‡ç¼–è¯‘_å¾®ä¿¡é€šçŸ¥         #Githubè®¾ç½®é‡Œéœ€æ·»å¾®ä¿¡SCKEY
      uses: emon100/Action-Serverchan@v2
      if: env.SERVERCHAN_SCKEY == 'true' || (github.event.inputs.wxtz == 'wxtz' && github.event.inputs.wxtz  != 'false')
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: ä¸»äºº${{ env.FIRMWARE_NAME }}ç¼–è¯‘å¼€å§‹å•¦
        desp: ä¸»äººæ‚¨è¦ç¼–è¯‘çš„[${{ env.FIRMWARE_NAME }}]å›ºä»¶æ­£åœ¨åŠªåŠ›è€•è€˜ä¸­,è¯·è€å¿ƒç­‰å¾…......


#-----------------------------------------------------------------------------------------------------------------
    - name: åˆå§‹åŒ–ç¯å¢ƒ #Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir


#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸‹è½½æºç  #Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt


#-----------------------------------------------------------------------------------------------------------------
    - name: åŠ è½½DIY_1è„šæœ¬ #Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default  # ä»“åº“â€œfeeds.conf.defaultâ€æ–‡ä»¶å¤¹ç§»åŠ¨è‡³openwrtæºç ç›®å½•ä¸‹
        
        chmod +x $DIY_P1_SH  # ç»™DIY_P1_SHæ‰§è¡Œæƒé™
        
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH  # æ‰§è¡ŒDIY_P1_SH
        
        git clone https://github.com/openwrt-dev/po2lmo.git   #ä¸‹è½½po2lmoä¾èµ–
        pushd po2lmo
        make && sudo make install
        popd
        
        git clone https://github.com/tuanqing/mknop reform   # N1çš„åœ¨çº¿æ‰“åŒ…ä¾èµ–
        git clone https://github.com/tuanqing/install-program package/install-program  # N1çš„ç¼–è¯‘é€‰é¡¹ï¼ˆç¼–è¯‘å‰å‹¾é€‰ï¼šUtilities--> install-programï¼‰

#-----------------------------------------------------------------------------------------------------------------
    - name: æ›´æ–°æº & å®‰è£…æº #Update feeds & Install feeds
      run: cd openwrt && ./scripts/feeds update -a
           cd openwrt && ./scripts/feeds install -a


#-----------------------------------------------------------------------------------------------------------------
    - name: åŠ è½½DIY_2è„šæœ¬ #Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files   # filesæ–‡ä»¶è¡¥ä¸ç§»åŠ¨è‡³ openwrtç›®å½•ä¸‹
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config   # ç§»åŠ¨â€œ.configâ€é…ç½®æ–‡ä»¶ è‡³ æºç ç›®å½•ä¸‹
        chmod +x $DIY_P2_SH      # ç»™DIY_P2_SHæ‰§è¡Œæƒé™
        
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH    # æ‰§è¡ŒDIY_P2_SH
        
        if [ $REPO_URL == "https://github.com/coolsnowwolf/lede" ]; then
         echo "NAME2=Lede-" >> $GITHUB_ENV
         echo "ZUOZHE=lean" >> $GITHUB_ENV
        elif [ $REPO_URL == "https://github.com/Lienol/openwrt" ]; then
         echo "NAME2=Lienol-" >> $GITHUB_ENV
         echo "ZUOZHE=lienol" >> $GITHUB_ENV
        elif [ $REPO_URL == "https://github.com/project-openwrt/openwrt" ]; then
         echo "NAME2=Project-" >> $GITHUB_ENV
         echo "ZUOZHE=CTCGFW" >> $GITHUB_ENV
        elif [ $REPO_URL == "https://github.com/openwrt/openwrt" ]; then
         echo "NAME2=Official-" >> $GITHUB_ENV
        fi
        
        rm -rf {LICENSE,README,README.md}     # åˆ é™¤æ— ç”¨è¯´æ˜
        rm -rf ./*/{LICENSE,README,README.md}
        rm -rf ./*/*/{LICENSE,README,README.md}
        
# 1-3ï¼šã€ç§»åŠ¨filesæ–‡ä»¶ã€‘ã€ã€ç§»åŠ¨å¹¶æ”¹åä¸ºconfigã€‘ã€ã€æå‡DIY2è„šæœ¬æƒé™ã€‘
# 4-5ï¼šã€åˆ‡æ¢åˆ°openwrtç›®å½•ã€‘ã€ã€æ‰§è¡ŒDIY2è„šæœ¬ã€‘
# 6-17ï¼šã€NAME2 = â€œlede-â€ æºç ä½œè€…åç§°ä¿¡æ¯ã€‘

#-----------------------------------------------------------------------------------------------------------------
    - name: SSHé“¾æ¥ï¼ˆåˆ°æ­¤é¢„è®¡10åˆ†é’Ÿï¼‰ #SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}


#-----------------------------------------------------------------------------------------------------------------
    # - name: æ•´ç†æ–‡ä»¶ #Load custom configuration
      # run: |
        # mkdir config1
        # cd openwrt
        # ls -a
        # cp .config ./config1
    # - name: ç¼–è¯‘å‰ä¸Šä¼ .configé…ç½®æ–‡ä»¶  #åˆ°githubç©ºé—´
      # uses: actions/upload-artifact@main    # ä¿®æ”¹å‰ï¼š@v2   å¤‡ç”¨ï¼š@main
      # with:
        # name: .config
        # path: ./config1
    - name: ä¸‹è½½DLåº“ #Download package
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;


#-----------------------------------------------------------------------------------------------------------------
    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶ #Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make -j$(($(nproc)+1)) || make -j1 || make -j1 V=s
        echo "::set-output name=status::success"
        
        DEVICE=$(egrep -o "CONFIG_TARGET.*DEVICE.*=y" .config | sed -r 's/.*(.*)=y/\0/')
        DEVICE2=$(egrep -o "CONFIG_TARGET.*_64_Generic=y" .config | sed -r 's/.*(.*)=y/\0/')
        if [ $DEVICE == "CONFIG_TARGET_x86_64_DEVICE_generic=y" ]; then
         echo "NAME1=x86-64" >> $GITHUB_ENV
        elif [ $DEVICE2 == "CONFIG_TARGET_x86_64_Generic=y" ]; then
         echo "NAME1=x86-64" >> $GITHUB_ENV
        elif [ ${{matrix.target}} == "Lede_phicomm_n1" -o ${{matrix.target}} == "Project_phicomm_n1" ];then
         echo "NAME1=n1,Vplus,Beikeyun,L1Pro,S9xxx" >> $GITHUB_ENV
        elif [ $DEVICE != "CONFIG_TARGET_x86_64_DEVICE_generic=y" ]; then
         grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > NAME1
         [ -s NAME1 ] && echo "NAME1=$(cat NAME1)" >> $GITHUB_ENV
        fi
        
        echo "date=$(date "+%y.%m.%d-%H%M")" >> $GITHUB_ENV
        echo "date1=$(date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
        echo "date2=$(date "+%Y%m%d%H%M%S")" >> $GITHUB_ENV


# 1-4ï¼šã€åˆ‡æ¢åˆ°openwrtç›®å½• å¹¶æ‰§è¡Œç¼–è¯‘ã€‘
# 5-16ï¼šã€NAME1 =æå–â€œx86-64â€            ï¼ˆå˜é‡å‰ä¸DEVICE_NAMEå¯¹ç­‰ï¼‰=æå–æ˜¯â€œgenericâ€ã€‘
# 5-7ï¼šã€DEVICE =LEDEæºç é…ç½®ï¼› DEVICE2 =Projectæºç é…ç½®ã€‘
# 17ï¼š ã€date  =æ—¶é—´æ ¼å¼: 21.02.03-1956ã€‘
# 18ï¼š ã€date1 =æ—¶é—´æ ¼å¼: 2021å¹´02æœˆ03å·-19ç‚¹56åˆ† ï¼ˆReleasesä¸»é¡µï¼‰ã€‘
# 19ï¼š ã€date2 =æ—¶é—´æ ¼å¼ï¼š202101292017   ï¼ˆä¸FILE_DATEå¯¹ç­‰ï¼‰Tags     ã€‘


#-----------------------------------------------------------------------------------------------------------------
    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ #Check space usage
      if: (!cancelled())
      run: df -hT
#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ binç›®å½•(å›ºä»¶+ipk) #Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt-bin-${{ env.NAME2 }}${{ env.NAME1 }}_${{ env.date }}
        path: openwrt/bin

#--------------------------N1åœ¨çº¿å¼€å§‹æ‰“åŒ…æ­¥éª¤æ·»åŠ åˆ°è¿™é‡Œ------------------
    - name: N1æœºå‹åœ¨çº¿æ‰“åŒ…ï¼ˆéN1åˆ é™¤æ­¤æ­¥éª¤ï¼‰ #N1ã€å¾®åŠ äº‘ã€è´å£³äº‘ã€æˆ‘å®¶äº‘ã€S9xxx 
      run: |
        cp openwrt/bin/targets/armvirt/*/*.tar.gz openwrt/reform/openwrt
        
        cd openwrt/reform
        sudo ./gen_openwrt -d -k latest
         
        devices=("phicomm-n1" "rk3328" "s9xxx" "vplus")
        cd out
        for x in ${devices[*]}; do
          cd $x
          filename=$(ls | awk -F '.img' '{print $1}')
          gzip *.img
          cd ../
          echo "firmware_$x=$filename" >> $GITHUB_ENV
        done
        
          cd ../../
          mv -f reform/out/*/*.img.gz bin/targets/armvirt/*

#-----------------------------------------------------------------------------------------------------------------
    - name: æ•´ç†æ–‡ä»¶ #Organize filesï¼ˆé»˜è®¤åªåˆ é™¤packagesï¼‰
      id: organizer  # å®¹æ˜“å‡ºé”™å’Œä¸‹é¢çš„å­—æ¯è¦ä¸€è‡´
#      if: env.ORGANIZE_FIRMWARE == 'true' && !cancelled()
      run: |
        mkdir config
        find openwrt/bin/targets/ -name "*config.buildinfo*" | xargs -i cp -f {} config
        
        cd openwrt/bin/targets/*/*
        rm -rf packages
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=status::success"
# 1-2ï¼šã€åˆ›å»ºconfigæ–‡ä»¶å¤¹ã€‘ã€ã€å¯»æ‰¾â€œconfig.buildinfoâ€æ–‡ä»¶ç§»åŠ¨å¹¶æ”¹åä¸º"config"ã€‘
# 3-4: ã€åˆ‡æ¢åˆ°å›ºä»¶ç›®å½•ä¸‹ã€‘ã€ã€åˆ é™¤â€œpackagesâ€æ–‡ä»¶å¤¹ã€‘
# 5-6: ã€FIRMWAREè®¾ç½®å˜é‡ã€‘ã€ã€åˆ—å‡ºæ–‡ä»¶å¤¹å†… æ‰€æœ‰åç§°ã€‘

#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ .configé…ç½®æ–‡ä»¶  #åˆ°githubç©ºé—´
      uses: actions/upload-artifact@main    # ä¿®æ”¹å‰ï¼š@v2   å¤‡ç”¨ï¼š@main
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true' && !cancelled()
      with:
        name: .config_${{ env.NAME2 }}${{ env.NAME1 }}_${{ env.date }}
        path: ./config


#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ å›ºä»¶åˆ°githubç©ºé—´ #Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      with:
        name: OpenWrt_${{ env.NAME2 }}${{ env.NAME1 }}_firmware_${{ env.date }}
        path: ${{ env.FIRMWARE }}


#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ å›ºä»¶åˆ°å¥¶ç‰›å¿«ä¼  #Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        
        echo "::warning file=å¥¶ç‰›å¿«ä¼ ::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"


#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ å›ºä»¶åˆ°WeTransfer #Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        
        echo "::warning file=WeTransferé“¾æ¥::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"


#-----------------------------------------------------------------------------------------------------------------
    - name: æå–ã€Œå¥¶ç‰›å¿«ä¼ ã€&ã€ŒWeTransferã€ä¸‹è½½é“¾æ¥ #è‡ªåŠ¨æå–é“¾æ¥
      if: steps.organizer.outputs.status == 'success' && env.EXTRACT_LINKS == 'true' && !cancelled()
      run: |

        echo "COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV

        echo "WETRANSFER_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV

#--------------------------------------------
#    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾ #Generate release tag
#      id: tag
#      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
#      run: |
#        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
#        touch release.txt
#        [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
#        [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
#        echo "::set-output name=status::success"
#--------------------------------------------

         # if [ -n "$FOLDERS" ]; then  curl "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" -d 
         # "chat_id=$TELEGRAM_CHAT_ID&text=ğŸ‰ æºç åŒæ­¥å¤±è´¥-18.06-$FOLDERSX...... ğŸ˜‹"; else curl 
         # "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" -d "chat_id=$TELEGRAM_CHAT_ID&text=ğŸ‰ æºç åŒæ­¥æˆåŠŸ-18.06...... ğŸ˜‹"; 
         # fi

#-----------------------------------------------------------------------------------------------------------------
    - name: ä¸Šä¼ å¹¶å‘å¸ƒå›ºä»¶ # è‡ªåŠ¨å‘å¸ƒå›ºä»¶ releasesä¸»é¡µä¸‹è½½
      uses: softprops/action-gh-release@v1
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
      with:
        name: ${{ env.date1 }} ã€Œ ${{ env.FIRMWARE_NAME }} ã€å›ºä»¶
        tag_name: ${{ env.date2 }}
        body: |            
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…[ ${{ env.ZUOZHE }}å¤§ç¥ ]æ— ç§åˆ†äº«ï¼
            
            ğŸ‰ [ ${{ env.FIRMWARE_NAME }} ]å›ºä»¶ä¸‹è½½ âœ¨
            -
            ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_URL }}
            
            â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_URL }}
            
            ğŸŒ´ é“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©ï¼Œæ— éœ€æ³¨å†Œç›´æ¥ä¸‹è½½ ğŸ¤
        files: ${{ env.FIRMWARE }}/*


#-----------------------------------------------------------------------------------------------------------------
    - name: åˆ é™¤å·¥ä½œæµè¿è¡Œ #Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 10           # ä¿ç•™å¤©æ•°ï¼ˆé»˜è®¤æ˜¯1ï¼‰
        keep_minimum_runs: 10    # ä¿å­˜æœ€å°‘è¿è¡Œæ•°ï¼ˆé»˜è®¤æ˜¯3ï¼‰


#-----------------------------------------------------------------------------------------------------------------
    - name: åˆ é™¤æ—§ç‰ˆæœ¬ #Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 10           # ä¿ç•™æœ€å°‘æ•°ï¼ˆé»˜è®¤æ˜¯3ï¼‰
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}


#-----------------------------------------------------------------------------------------------------------------
    - name: ç»“æŸç¼–è¯‘_å¾®ä¿¡é€šçŸ¥
      uses: emon100/Action-Serverchan@v2
      if: steps.organizer.outputs.status == 'success' && env.SERVERCHAN_SCKEY == 'true' || (github.event.inputs.wxtz == 'wxtz' && github.event.inputs.wxtz  != 'false')
      with:
        SCKEY: ${{ secrets.SCKEY }}
        text: æ­å–œä¸»äºº${{ env.FIRMWARE_NAME }}å›ºä»¶ç¼–è¯‘æˆåŠŸï¼
        desp: æˆ‘äº²çˆ±çš„ä¸»äººæ‚¨è¦ç¼–è¯‘çš„[ ${{ env.FIRMWARE_NAME }} ]å›ºä»¶é¡ºåˆ©ç¼–è¯‘å®Œæˆäº†ï¼
        
        
              å®Œæˆæ—¶é—´ï¼š${{ env.date1 }}
              
              
              å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}
              
              
              å¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}
              
              
              WeTransferï¼š${{ env.WETRANSFER_URL }}
      
      
              ç¥å°ä¸»äººè§äººçˆ±ï¼ŒèŠ±è§èŠ±å¼€ï¼Œè½¦è§è½¦è½½ï¼Œå¤©å¤©å¥½å¿ƒæƒ…ğŸˆï¼ï¼ï¼
#--------------------------------------------
